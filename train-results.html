<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Train Results</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    :root {
      --accent: #f7b949;
      --dark: #222;
      --muted: #6b6b6b;
      --card: #fff;
    }
    html,body{height:100%; margin:0; padding:0; overflow-x:hidden;}
    body {
      font-family: Inter, system-ui, Arial, sans-serif;
      background: var(--accent);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* container */
    .app {
      max-width: 820px;
      margin: 0 auto;
      background: var(--card);
      min-height: 100vh;
      border-radius: 0 0 20px 20px;
      overflow-x: hidden; /* ensure no horizontal scroll */
    }

    /* header */
    .top {
      padding: 18px;
      background: var(--accent);
      color: white;
      position: relative;
      border-radius: 0 0 14px 14px;
    }
    .top .back { position:absolute; left:14px; top:18px; font-size:20px; cursor:pointer; }
    .top h1 { margin:0; font-size:20px; text-align:center; }
    .trip {
      padding:12px 10px 4px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
    }
    .pill {
      background:#fff;
      color: #222;
      padding:8px 12px;
      border-radius:12px;
      font-weight:700;
      min-width:110px;
      text-align:center;
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
    }

    /* results list */
    .results {
      padding: 14px;
    }
    .notice { text-align:center; color:var(--muted); margin:12px 6px; font-weight:600; }

    .card {
      background:#fff;
      border-radius:12px;
      border:1px solid #eee;
      padding:12px;
      margin-bottom:12px;
      box-shadow:0 6px 18px rgba(0,0,0,0.03);
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap; /* allow wrapping on small screens */
    }

    .meta {
      flex: 0 0 180px;
      min-width: 110px;
    }
    .meta .num { font-weight:800; color:var(--dark); font-size:16px; }
    .meta .name { color:var(--muted); font-size:13px; margin-top:6px; }

    .times {
      flex:1;
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      min-width:180px;
    }
    .timeblk { text-align:center; min-width:95px; }
    .timeblk .t { font-weight:800; font-size:16px; }
    .timeblk .s { color:var(--muted); font-size:12px; margin-top:4px; }

    .duration { text-align:center; min-width:80px; color:var(--muted); font-size:13px; }

    .actions { display:flex; gap:8px; align-items:center; min-width:160px; justify-content:flex-end; }
    .btn { padding:8px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:700; font-size:14px; }
    .btn.secondary { background:#f3f3f3; color:var(--dark); }
    .btn.primary { background:var(--dark); color:white; }

    /* loader */
    .loader { width:26px; height:26px; border-radius:50%; border:4px solid #fff; border-top-color:transparent; animation:spin .7s linear infinite; display:inline-block; vertical-align:middle; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* availability drawer */
    .drawer {
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: 12px;
      max-width: 820px;
      margin: auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.18);
      padding: 14px;
      z-index: 120;
      transform: translateY(120%);
      transition: transform 260ms ease;
    }
    .drawer.open { transform: translateY(0); }
    .drawer .head { display:flex; justify-content:space-between; align-items:center; }
    .drawer .close { cursor:pointer; color:var(--muted); font-weight:700; }
    .avail-grid { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .avail-item { flex:1 1 120px; border:1px solid #eee; padding:8px; border-radius:8px; text-align:center; }

    /* responsive tweaks */
    @media (max-width:520px) {
      .meta { flex:0 0 120px; min-width:90px; }
      .times { min-width:160px; }
      .actions { min-width:130px; }
      .pill { min-width: 90px; padding:8px 10px; font-size:13px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <i class="fas fa-arrow-left back" onclick="history.back()"></i>
      <h1>Available Trains</h1>

      <div class="trip" id="tripSummary">
        <div class="pill" id="fromLabel">—</div>
        <div class="pill" id="toLabel">—</div>
        <div class="pill" id="dateLabel">—</div>
      </div>
    </div>

    <div class="results" id="resultsArea">
      <p class="notice" id="statusMsg">Checking for trains…</p>
      <div style="text-align:center"><span class="loader" id="globalLoader"></span></div>
    </div>
  </div>

  <!-- Drawer for seat availability -->
  <div class="drawer" id="drawer" aria-hidden="true">
    <div class="head">
      <div>
        <strong id="drawerTitle">Availability</strong><br>
        <small id="drawerSub" style="color:var(--muted)"></small>
      </div>
      <div>
        <button class="btn secondary" id="reloadAvailBtn">Reload</button>
        <span class="close" id="closeDrawerBtn">✕</span>
      </div>
    </div>

    <div style="margin-top:8px">
      <label style="display:block; font-weight:700; margin-bottom:6px">Date</label>
      <input type="date" id="availDate" style="padding:8px; border-radius:8px; border:1px solid #eee;">
    </div>

    <div style="margin-top:12px;">
      <div style="font-weight:700; margin-bottom:8px">Class availability</div>
      <div class="avail-grid" id="availGrid">
        <!-- items injected -->
      </div>
      <div style="margin-top:10px; color:var(--muted); font-size:13px">
        Quota: General (GN). Use seat API for other quotas.
      </div>
    </div>
  </div>

    <script>

        
    async function loadTrains() {
        if (window.allTrains) return window.allTrains;
        const res = await fetch("trains-full.json");
        window.allTrains = await res.json();
        return window.allTrains;
    }

    function extractCode(str) {
        const m = str.match(/\((.*?)\)/);
        return m ? m[1] : "";
    }

    function findTrainsBetween(trains, from, to) {
        return trains.filter(t => {
            const stops = t.stops || [];
            const fromIndex = stops.findIndex(s => s.stationCode === from);
            const toIndex = stops.findIndex(s => s.stationCode === to);
            return fromIndex !== -1 && toIndex !== -1 && fromIndex < toIndex;
        });
    }

    async function showResults() {
        const url = new URL(window.location.href);
        const fromRaw = url.searchParams.get("from");
        const toRaw = url.searchParams.get("to");

        const from = extractCode(fromRaw);
        const to = extractCode(toRaw);

        const trains = await loadTrains();
        const results = findTrainsBetween(trains, from, to);

        const container = document.getElementById("trainList");
        container.innerHTML = "";

        if (results.length === 0) {
            container.innerHTML = "<p>No trains found.</p>";
            return;
        }

        results.forEach(t => {
            const div = document.createElement("div");
            div.className = "train-card";

            div.innerHTML = `
                <h3>${t.trainName} (${t.trainNo})</h3>
                <p><strong>${from}</strong> → <strong>${to}</strong></p>
                <p>Runs: ${t.runDays.join(", ")}</p>
                <button onclick="window.location.href='https://www.irctc.co.in/nget/train-search'">
                    Book on IRCTC
                </button>
            `;
            container.appendChild(div);
        });
    }

    window.onload = showResults;


    /* -----------------------------------------------------------
    CONFIG & UTIL
    ----------------------------------------------------------- */
    const API_KEY = "cce4060c646790bba83ed90f970ea88d"; // your key
    /* -----------------------------------------------------------
    CLOUDLFARE WORKER PROXY ENDPOINTS (NO CORS)
    ----------------------------------------------------------- */

    // Your Worker URL (must end with /)
    const WORKER = "https://withered-king-c66a.shivmedia20.workers.dev/";

    // Train between stations
    const TRAIN_BETWEEN_ENDPOINT = (from, to) =>
    `${WORKER}train-between?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`;

    // Seat availability
    const SEAT_AVAIL_ENDPOINT = (train, from, to, date) =>
    `${WORKER}seat?train=${encodeURIComponent(train)}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&date=${encodeURIComponent(date)}`;

    function qs(k){ return new URLSearchParams(location.search).get(k) || ""; }
    function extractCode(s) {
    if(!s) return "";
    const m = s.match(/\(([A-Za-z0-9]+)\)/);
    return m ? m[1].toUpperCase() : s.trim();
    }
    function ymdToDdmmyyyy(ymd) {
    if(!ymd) return "";
    // accept YYYY-MM-DD or already DD-MM-YYYY
    if(/\d{4}-\d{2}-\d{2}/.test(ymd)) {
        const [y,m,d] = ymd.split("-");
        return `${d}-${m}-${y}`;
    }
    return ymd;
    }
    function el(id){ return document.getElementById(id); }

    /* -----------------------------------------------------------
    READ URL (Option A)
    ----------------------------------------------------------- */
    const rawFrom = qs("from");
    const rawTo = qs("to");
    const rawDate = qs("date");

    el("fromLabel").textContent = rawFrom || "—";
    el("toLabel").textContent = rawTo || "—";
    el("dateLabel").textContent = rawDate || "—";

    // extract codes
    const fromCode = extractCode(rawFrom);
    const toCode = extractCode(rawTo);

    if(!fromCode || !toCode) {
    el("statusMsg").textContent = "Invalid station format in URL (expect: Station Name (CODE)).";
    el("globalLoader").style.display = "none";
    // don't proceed further
    }

    /* -----------------------------------------------------------
    LOAD TRAINS (live)
    ----------------------------------------------------------- */
    async function loadTrains() {
    el("statusMsg").textContent = "Searching trains…";
    el("globalLoader").style.display = "inline-block";
    el("resultsArea").querySelectorAll(".card").forEach(n=>n.remove());

    try {
        const url = TRAIN_BETWEEN_ENDPOINT(fromCode, toCode);
        const res = await fetch(url);
        const json = await res.json();

        el("globalLoader").style.display = "none";

        // IndianRailApi returns field 'Trains' (case-sensitive) usually
        const list = json && (json.Trains || json.trains || json.data || json);
        if(!Array.isArray(list) || list.length === 0) {
        el("statusMsg").textContent = "No trains found for selected route/date.";
        return;
        }
        el("statusMsg").style.display = "none";

        renderTrains(list);
    } catch (err) {
        console.error("Load trains failed:", err);
        el("globalLoader").style.display = "none";
        el("statusMsg").textContent = "Failed to load trains. Try again later.";
    }
    }

    /* -----------------------------------------------------------
    RENDER
    ----------------------------------------------------------- */
    function renderTrains(list) {
    const area = el("resultsArea");
    area.innerHTML = ""; // clear

    list.forEach(t => {
        // normalize some expected fields
        const trainNumber = t.TrainNo || t.train_no || t.TrainNumber || t.number || t.no;
        const trainName = t.TrainName || t.name || t.Train || t.train;
        const src = t.Source || t.source || t.src || t.from;
        const dst = t.Destination || t.destination || t.dst || t.to;
        const dep = t.SourceDepartureTime || t.DepartureTime || t.scheduledDep || t.DepTime || t.departure || t.src_time || "";
        const arr = t.DestinationArrivalTime || t.ArrivalTime || t.scheduledArr || t.ArrTime || t.arrival || t.dest_time || "";
        const travelTime = t.TravelTime || t.Travel_Duration || t.duration || t.travel_time || "";

        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
        <div class="meta">
            <div class="num">${escapeHtml(trainNumber)}</div>
            <div class="name">${escapeHtml(trainName)}</div>
        </div>

        <div class="times">
            <div class="timeblk">
            <div class="t">${escapeHtml(dep)}</div>
            <div class="s">${escapeHtml(src)} ${t.SourceCode ? '('+t.SourceCode+')':''}</div>
            </div>

            <div class="duration">${escapeHtml(travelTime || "—")}</div>

            <div class="timeblk">
            <div class="t">${escapeHtml(arr)}</div>
            <div class="s">${escapeHtml(dst)} ${t.DestinationCode ? '('+t.DestinationCode+')':''}</div>
            </div>
        </div>

        <div class="actions">
            <button class="btn secondary" data-train='${escapeJson(t)}'>Check Availability</button>
            <button class="btn primary" data-trainno='${escapeHtml(trainNumber)}'>Book Now</button>
        </div>
        `;

        // wire buttons
        const availBtn = card.querySelector(".btn.secondary");
        availBtn.addEventListener("click", () => openDrawerForTrain(t));

        const bookBtn = card.querySelector(".btn.primary");
        bookBtn.addEventListener("click", () => {
        // open IRCTC web search — user completes booking on IRCTC
        const webUrl = `https://www.irctc.co.in/nget/train-search?source=${encodeURIComponent(fromCode)}&destination=${encodeURIComponent(toCode)}&doj=${encodeURIComponent(rawDate)}&train=${encodeURIComponent(trainNumber)}`;
        window.open(webUrl, "_blank");
        });

        area.appendChild(card);
    });
    }

    /* -----------------------------------------------------------
    AVAILABILITY DRAWER
    ----------------------------------------------------------- */
    const drawer = el("drawer");
    const availGrid = el("availGrid");
    const drawerTitle = el("drawerTitle");
    const drawerSub = el("drawerSub");
    const availDateInput = el("availDate");
    const reloadBtn = el("reloadAvailBtn");
    const closeBtn = el("closeDrawerBtn");

    let currentTrainForAvail = null;
    const CHECK_CLASSES = ["1A","2A","3A","SL","CC"]; // selected classes (option A)

    // initialize avail date input with rawDate converted to yyyy-mm-dd (for input control)
    (function initAvailDate() {
    if (!rawDate) return;
    // rawDate expected as YYYY-MM-DD; convert to same format for date input (it accepts YYYY-MM-DD)
    // but if user passed other format, try to parse
    const d = new Date(rawDate);
    if (!isNaN(d)) {
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const day = String(d.getDate()).padStart(2,'0');
        availDateInput.value = `${y}-${m}-${day}`;
    } else {
        // fallback to today+1
        const t = new Date();
        t.setDate(t.getDate()+1);
        const y = t.getFullYear();
        const m = String(t.getMonth()+1).padStart(2,'0');
        const day = String(t.getDate()).padStart(2,'0');
        availDateInput.value = `${y}-${m}-${day}`;
    }
    })();

    function openDrawerForTrain(train) {
    currentTrainForAvail = train;
    drawerTitle.textContent = `${train.TrainName || train.name || train.Train || ''} (${train.TrainNo || train.train_no || train.no || ''})`;
    drawerSub.textContent = `${rawFrom} → ${rawTo}`;
    renderAvailPlaceholder();
    drawer.classList.add("open");
    drawer.setAttribute("aria-hidden","false");
    // load availability immediately
    loadAvailabilityForTrain(train);
    }

    closeBtn.addEventListener("click", () => {
    drawer.classList.remove("open");
    drawer.setAttribute("aria-hidden","true");
    });

    reloadBtn.addEventListener("click", () => {
    if (currentTrainForAvail) loadAvailabilityForTrain(currentTrainForAvail, true);
    });

    function renderAvailPlaceholder() {
    availGrid.innerHTML = CHECK_CLASSES.map(c => `<div class="avail-item"><div style="font-weight:800">${c}</div><div style="color:var(--muted); margin-top:8px">Loading…</div></div>`).join('');
    }

    /* Load availability (LIVE) */
    async function loadAvailabilityForTrain(train, force=false) {
    if(!train) return;
    const trainNo = train.TrainNo || train.train_no || train.TrainNumber || train.number || train.no;
    // The seat API requires DD-MM-YYYY format
    const chosenDate = availDateInput.value; // YYYY-MM-DD
    const ddmmyyyy = ymdToDdmmyyyy(chosenDate);

    // show loading state
    renderAvailPlaceholder();
    reloadBtn.disabled = true;
    reloadBtn.textContent = "Loading…";

    try {
        const from = fromCode;
        const to = toCode;
        const url = SEAT_AVAIL_ENDPOINT(trainNo, from, to, ddmmyyyy);
        const res = await fetch(url);
        const data = await res.json();

        reloadBtn.disabled = false;
        reloadBtn.textContent = "Reload";

        // Parse possible response shapes — be defensive
        // IndianRailApi seat response sometimes under data or Availability
        let availabilityList = null;

        if (data && (data.Availability || data.availability)) {
        availabilityList = data.Availability || data.availability;
        } else if (data && data.data && (data.data.Availability || data.data.availability)) {
        availabilityList = data.data.Availability || data.data.availability;
        } else if (data && data.CurrentStatus) {
        // Some providers return CurrentStatus or similar
        availabilityList = [ { Class: data.CurrentStatus.Class || "—", Status: data.CurrentStatus.Status || JSON.stringify(data) } ];
        } else if (Array.isArray(data)) {
        availabilityList = data;
        } else {
        // if response structure unknown, try to inspect keys
        availabilityList = data && data.data ? data.data : data;
        }

        // build a map class => status
        const map = {};
        if (Array.isArray(availabilityList)) {
        // expected elements might be like {Class:"3A", Status:"AVAILABLE 10"}
        availabilityList.forEach(item => {
            const cls = item.Class || item.class || item.name || item.Code || "";
            const stat = item.Status || item.status || item.Available || item.availability || JSON.stringify(item);
            if (cls) map[cls.toUpperCase()] = stat;
        });
        } else if (typeof availabilityList === "object") {
        // some APIs return object keyed by class
        Object.keys(availabilityList).forEach(k => map[k.toUpperCase()] = availabilityList[k]);
        }

        // render grid
        availGrid.innerHTML = CHECK_CLASSES.map(c => {
        const status = map[c] || "—";
        return `<div class="avail-item">
                    <div style="font-weight:800">${escapeHtml(c)}</div>
                    <div style="margin-top:8px; color:var(--muted)">${escapeHtml(String(status))}</div>
                </div>`;
        }).join('');

    } catch (err) {
        console.error("Seat API error", err);
        reloadBtn.disabled = false;
        reloadBtn.textContent = "Reload";
        availGrid.innerHTML = `<div style="color:red; padding:12px">Failed to load availability. Try again.</div>`;
    }
    }

    /* Convert yyyy-mm-dd to dd-mm-yyyy */
    function ymdToDdmmyyyy(ymd) {
    if(!ymd) return "";
    const m = ymd.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return ymd;
    return `${m[3]}-${m[2]}-${m[1]}`;
    }

    /* -----------------------------------------------------------
    START
    ----------------------------------------------------------- */
    loadTrains();

    /* -----------------------------------------------------------
    SMALL HELPERS
    ----------------------------------------------------------- */
    function escapeHtml(s){ if(s===null||s===undefined) return ""; return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
    function escapeJson(obj){
    try {
        return JSON.stringify(obj).replace(/'/g,"");
    } catch(e){
        return "{}";
    }
    }

    /* alias used earlier */
    function escapeJsonStr(o){ return escapeJson(o); }
    function escapeJson(o){ return escapeJsonStr(o); }

    </script>
</body>
</html>
