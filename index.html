<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* --- History & Icon Styles --- */
.history-header {
    padding: 8px 15px;
    font-size: 12px;
    color: #888;
    background: #f9f9f9;
    border-bottom: 1px solid #eee;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.suggest-content-wrapper {
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Icon inside the suggestion list */
.suggest-icon {
    color: #aaa;
    font-size: 14px;
    width: 20px;
    text-align: center;
}

/* Highlight history icon differently */
.suggest-item.history-item .suggest-icon {
    color: var(--secondary-color); /* Use your teal color */
}
        /* Variables for easy color adjustments */
        :root {
            --primary-color: #f7b949; /* The orange/yellow color */
            --secondary-color: #07a2a2; /* PRECISE Teal/Green color */
            --text-color-dark: #000000; /* Changed to pure Black */
            --text-color-light: #fff;
            --border-radius-large: 20px;
            --border-radius-small: 12px;
        }

        /* --- Global Reset and Fix for White Space --- */
        html {
            height: 100%;
            overflow-x: hidden; /* Prevents horizontal scrollbar */
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: Arial, sans-serif; 
            background-color: #fff;
            /* Changed to margin-based centering for better compatibility and to remove extra space */
            margin: 0 auto; 
            min-height: 100vh;
            width: 100%;
        }

        /* Container to simulate the mobile view */
        .container {
            width: 100%;
            max-width: 450px; /* Mobile size constraint */
            /* Removed box-shadow to prevent it from causing border effect on wide screens, 
               or you may adjust it to be inner shadow if desired */
        }

        /* --- Header Section (Orange Background) --- */
        .header {
            background-color: var(--primary-color);
            padding: 30px 20px 40px 20px; 
            position: relative;
            color: var(--text-color-dark);
        }

        .header-text {
    margin-bottom: 20px;
    padding-top: 0; 
}

        .header h1 {
            font-size: 28px;
            font-weight: 400;
            margin: 0;
        }

        .header h2 {
            font-size: 30px;
            font-weight: 700;
            margin: 0;
            padding-bottom: 6px;
        }

        /* Profile Icon */
      /* Profile Icon - Top Right */
.profile-icon {
    position: absolute;
    top: 30px;      /* Vertical spacing */
    right: 20px;    /* MOVED TO RIGHT */
    left: auto;     /* Ensure left is unset */
    background-color: rgba(0, 0, 0, 0.1); 
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none; /* No underline */
    z-index: 10;
    cursor: pointer;
    transition: background-color 0.3s;
}

.profile-icon:hover {
    background-color: rgba(0, 0, 0, 0.2);
}

.profile-icon i {
    font-size: 18px;
    color: var(--text-color-dark);
}

/* Reset Header Text (No extra padding needed for right-aligned icon) */


        /* Search Area */
        .search-prompt {
            font-size: 16px;
            margin-top: 25px; 
            margin-bottom: 10px;
            color: var(--text-color-dark);
        }

        .search-bar-wrapper {
            position: relative; /* Crucial for autosuggest positioning */
        }

        .search-bar {
            display: flex;
            gap: 10px;
            height: 50px;
            align-items: center;
            width: 100%;
        }
        
        .search-bar input {
            flex-grow: 1;
            min-width: 0; 
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 10px; 
            font-size: 16px;
            height: 50px;
        }
        
        .search-bar .search-button {
            flex-shrink: 0;
            flex-grow: 0;
            width: 50px; 
            font-size: larger;
            height: 50px; 
            padding: 0;
            border-radius: 10px; 
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            background-color: #303330;
            color: white; 
        }
        
        /* --- Autosuggest Styles --- */
        .suggest-box {
            position: absolute;
            top: 100%; 
            left: 0;
            z-index: 1000;
            background: var(--text-color-light);
            border: 1px solid #ccc;
            border-radius: 10px; 
            width: 100%;
            max-height: 240px;
            overflow-y: auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-top: 2px;
            /* Ensures borders are contained */
            border-top: none; 
        }
        .suggest-box.hidden {
            display: none;
        }
        .suggest-item {
            padding: 10px 15px;
            cursor: pointer;
            font-size: 16px;
            border-bottom: 1px solid #eee;
        }
        .suggest-item:hover, .suggest-item.active { 
            background: #f0f0f0;
            font-weight: 600;
        }
        .suggest-item:last-child { border-bottom:none }
        .suggest-text {
            font-weight: 500;
        }
        .suggest-subtext {
            color: #6b7280;
            font-size: 12px;
        }
        /* --- Main Content Section (White Background) --- */
        .main-content {
            background-color: var(--text-color-light);
            padding: 20px; 
            border-top-left-radius: var(--border-radius-large); 
            border-top-right-radius: var(--border-radius-large);
            margin-top: -10px;
            position: relative; 
            z-index: 10; /* Ensure it sits above the header edge */
        }

        .main-content h3 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-color-dark);
        }

        /* Quick Links Grid */
        .quick-links {
            margin-bottom: 30px;
        }

        .links-grid {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .link-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: 18%; 
            cursor: pointer;
        }

        .link-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--secondary-color); 
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .link-icon i {
            font-size: 24px;
            color: var(--text-color-dark); 
        }
        
        .link-item span {
            font-size: 12px;
            color: var(--text-color-dark);
        }

        /* Also Check List */
        .also-check {
            margin-bottom: 10px; 
        }

        .check-list {
            display: flex;
            flex-direction: column;
            gap: 25px; 
        }

        .check-item {
            width: 100%;
            height: 60px;
            display: flex;
            align-items: center;
            border: none;
            border-radius: var(--border-radius-small);
            padding: 0 20px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            background-color: var(--secondary-color);
            color: var(--text-color-dark);
        }

        .check-item i {
            font-size: 24px;
            margin-right: 15px;
            color: var(--text-color-dark);
        }
         @keyframes shake {
  0% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  50% { transform: translateX(5px); }
  75% { transform: translateX(-5px); }
  100% { transform: translateX(0); }
  
}
    </style>
</head>
<body>
    <div class="container">
       <header class="header">
    <a href="profile.html" class="profile-icon">
        <i class="fas fa-user"></i>
    </a>

    <div class="header-text">
        <h1>Welcome,</h1>   
        <h2 id="userNameDisplay">Loading...</h2>
    </div>
    
    <p class="search-prompt">Search for your favourite place</p>
    
    <div class="search-bar-wrapper"> 
        <div class="search-bar">
            <input 
                type="text" 
                id="cityInput" 
                placeholder="Search here"
                autocomplete="off" 
                autocorrect="off" 
                spellcheck="false"
            >
            <button class="search-button" id="searchBtn">
                <i class="fas fa-search"></i>
            </button>
        </div>
        <div id="citySuggestions" class="suggest-box hidden"></div>
    </div>
</header>

        <main class="main-content">
            <section class="quick-links">
                <h3>Quick links</h3>
                <div class="links-grid">
                    <div class="link-item" data-file="weather.html">
                        <div class="link-icon"><i class="fas fa-sun"></i></div>
                        <span>Weather</span>
                    </div>
                    <div class="link-item" data-file="flights.html">
                        <div class="link-icon"><i class="fas fa-plane"></i></div>
                        <span>Flights</span>
                    </div>
                    <div class="link-item" data-file="Railway.html">
                        <div class="link-icon"><i class="fas fa-train"></i></div>
                        <span>Trains</span>
                    </div>
                    <div class="link-item" data-file="bus.html">
                        <div class="link-icon"><i class="fas fa-bus"></i></div>
                        <span>Bus</span>
                    </div>
                    <div class="link-item" data-file="hotels.html">
                        <div class="link-icon"><i class="fas fa-hotel"></i></div>
                        <span>Hotel</span>
                    </div>
                </div>
            </section>

            <section class="also-check">
                <h3>Also check</h3>
                <div class="check-list">
                    <button class="check-item travel">
                        <i class="fas fa-clipboard-list"></i>
                        <span>Travel Checklist</span>
                    </button>
                    <button class="check-item category">
                        <i class="fas fa-th-large"></i>
                        <span>Category Wise Destinations</span>
                    </button>
                    <button class="check-item settings">
                        <i class="fas fa-suitcase-rolling"></i>
                        <span>My Bookings</span>
                    </button>
                    <button class="check-item faqs">
                        <i class="fas fa-plus-circle"></i>
                        <span>FAQs</span>
                    </button>
                </div>
            </section>
        </main>
    </div>

    <script type="module">

    /* ------------------- FIREBASE IMPORTS ------------------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    /* ------------------- CONFIG ------------------- */
    const hardcodedFirebaseConfig = {
        apiKey: "AIzaSyDtkaHB2ER0RAOpsbW-Eg65wSe7G4Uwrkw",
        authDomain: "travelassistant-1baed.firebaseapp.com",
        projectId: "travelassistant-1baed",
        storageBucket: "travelassistant-1baed.firebasestorage.app",
        messagingSenderId: "67570490262",
        appId: "1:67570490262:web:7164a2d838b5517a325bb7"
    };
    const appId = "travelassistant-1baed";
    const firebaseConfig = hardcodedFirebaseConfig;

    /* ------------------- INITIALIZE FIREBASE ------------------- */
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ------------------- USER NAME DISPLAY LOGIC ------------------- */
    const nameEl = document.getElementById("userNameDisplay"); 

    function loadUserName() {
        const userUid = localStorage.getItem('userUid');
        const userEmail = localStorage.getItem('userEmail');

        if (!userUid || !userEmail) {
            nameEl.textContent = "Guest";
            return;
        }

        const profileRef = doc(db, "artifacts", appId, "users", userUid, "profile", "data");
        
        getDoc(profileRef)
            .then(snap => {
                let displayedName = userEmail.split("@")[0]; 
                if (snap.exists()) {
                    const fetchedName = snap.data().name; 
                    displayedName = fetchedName || userEmail.split("@")[0];
                }
                nameEl.textContent = displayedName;
            })
            .catch(e => {
                console.error("Error loading profile:", e);
                nameEl.textContent = "Traveler";
            });
    }
    
    /* ------------------- CITY AUTOSUGGEST & HISTORY LOGIC ------------------- */

    let allCities = [];
    const HISTORY_KEY = 'travel_search_history';
    const MAX_HISTORY = 5; // How many recent searches to show

    /**
     * Fetches city data from JSON files.
     */
    async function loadCityData() {
        try {
            const [res1, res2] = await Promise.all([
                fetch('./cities1.json'),
                fetch('./cities2.json')
            ]);

            if (!res1.ok || !res2.ok) throw new Error('City data load failed');

            const cities1Data = await res1.json();
            const cities2Data = await res2.json();

            const citySet = new Set();
            const results = [];

            // 1. Process cities1.json
            for (const state in cities1Data) {
                if (cities1Data.hasOwnProperty(state)) {
                    cities1Data[state].forEach(city => {
                        const normalizedCity = city.toLowerCase().trim();
                        if (!citySet.has(normalizedCity)) {
                            citySet.add(normalizedCity);
                            results.push({
                                city: city.trim(),
                                state: state.trim(),
                                type: 'suggestion' // Mark as prediction
                            });
                        }
                    });
                }
            }

            // 2. Process cities2.json
            cities2Data.forEach(item => {
                const city = item.name;
                const subcountry = item.subcountry;
                if (city && subcountry) {
                    const normalizedCity = city.toLowerCase().trim();
                    if (!citySet.has(normalizedCity)) {
                        citySet.add(normalizedCity);
                        results.push({
                            city: city.trim(),
                            state: subcountry.trim(),
                            type: 'suggestion'
                        });
                    }
                }
            });

            allCities = results;
            console.log(`Loaded ${allCities.length} cities.`);

        } catch (error) {
            console.error('Error loading city data:', error);
        }
    }

    /**
     * HISTORY MANAGER
     */
    function getSearchHistory() {
        const stored = localStorage.getItem(HISTORY_KEY);
        return stored ? JSON.parse(stored) : [];
    }

    function saveToHistory(cityName) {
        if (!cityName) return;
        let history = getSearchHistory();
        
        // Remove duplicates (case insensitive)
        history = history.filter(item => item.toLowerCase() !== cityName.toLowerCase());
        
        // Add to beginning
        history.unshift(cityName);
        
        // Limit size
        if (history.length > MAX_HISTORY) history.pop();
        
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    }

    /**
     * FILTERING
     */
    function filterCities(query) {
        const q = query.trim().toLowerCase();
        if (q.length === 0) return [];

        return allCities.filter(cityObj => {
            return cityObj.city.toLowerCase().startsWith(q);
        }).slice(0, 10); 
    }

    const cityInputEl = document.getElementById('cityInput');
    const suggestionsBox = document.getElementById('citySuggestions');

    function escapeHtml(s) {
        return (s || '').replace(/[&<>\"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
    }

    function removeSuggestBox() {
        suggestionsBox.classList.add('hidden');
        suggestionsBox.innerHTML = '';
    }

    /**
     * Renders suggestions. 
     * @param {Array} list - Array of objects.
     * @param {Boolean} isHistoryMode - If true, adds a header and specific styling.
     */
    function showSuggestions(list, isHistoryMode = false) {
        removeSuggestBox(); 
        if (!list || list.length === 0) return;

        suggestionsBox.classList.remove('hidden');

        // Add "Recent Searches" header if in history mode
        if (isHistoryMode) {
            const header = document.createElement('div');
            header.className = 'history-header';
            header.textContent = 'Recent Searches';
            suggestionsBox.appendChild(header);
        }

        list.forEach((itemData, index) => {
            const item = document.createElement('div');
            item.className = isHistoryMode ? 'suggest-item history-item' : 'suggest-item';
            
            // If it's history, itemData is just a string (city name). 
            // If it's prediction, itemData is an object {city, state}.
            const cityName = isHistoryMode ? itemData : itemData.city;
            const subText = isHistoryMode ? 'History' : itemData.state;
            const iconClass = isHistoryMode ? 'fa-clock' : 'fa-location-dot';

            item.dataset.cityname = cityName;
            item.dataset.index = index; 

            item.innerHTML = `
                <div class="suggest-content-wrapper">
                    <i class="fas ${iconClass} suggest-icon"></i>
                    <div>
                        <div class="suggest-text">${escapeHtml(cityName)}</div>
                        <div class="suggest-subtext">${escapeHtml(subText)}</div>
                    </div>
                </div>
            `;

            item.addEventListener('click', () => {
                cityInputEl.value = cityName;
                saveToHistory(cityName); // Refresh timestamp/order in history
                removeSuggestBox();
                // Trigger search immediately on click
                performSearch(cityName);
            });
            suggestionsBox.appendChild(item);
        });
    }

    let debounceTimer = null;

    // 1. INPUT EVENT: Typing logic
    cityInputEl.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        const query = cityInputEl.value.trim();

        if (query.length < 1) { 
            // If user clears input, show history again
            const history = getSearchHistory();
            if (history.length > 0) showSuggestions(history, true);
            else removeSuggestBox();
            return;
        }

        debounceTimer = setTimeout(() => {
            const results = filterCities(query);
            showSuggestions(results, false); // false = Prediction mode
        }, 180); 
    });

    // 2. FOCUS EVENT: Show history on click
    cityInputEl.addEventListener('focus', () => {
        const query = cityInputEl.value.trim();
        if (query.length === 0) {
            const history = getSearchHistory();
            if (history.length > 0) {
                showSuggestions(history, true); // true = History mode
            }
        }
    });

    // Close suggestions when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-bar-wrapper') && !suggestionsBox.classList.contains('hidden')) {
            removeSuggestBox();
        }
    });

    // Keyboard navigation
    cityInputEl.addEventListener("keydown", function(event) {
        const items = suggestionsBox.querySelectorAll('.suggest-item');
        if (suggestionsBox.classList.contains('hidden') || items.length === 0) {
            if (event.key === "Enter") {
                document.getElementById("searchBtn").click();
            }
            return;
        }

        let activeItem = suggestionsBox.querySelector('.suggest-item.active');
        let nextActive = null;

        if (event.key === "ArrowDown") {
            event.preventDefault();
            if (!activeItem) nextActive = items[0];
            else {
                activeItem.classList.remove('active');
                nextActive = activeItem.nextElementSibling;
                // Skip header if it exists
                if (nextActive && nextActive.classList.contains('history-header')) {
                    nextActive = nextActive.nextElementSibling;
                }
                if (!nextActive) nextActive = items[0]; // Loop back
            }
        } else if (event.key === "ArrowUp") {
            event.preventDefault();
            if (!activeItem) nextActive = items[items.length - 1];
            else {
                activeItem.classList.remove('active');
                nextActive = activeItem.previousElementSibling;
                if (nextActive && nextActive.classList.contains('history-header')) {
                     // Skip header going up
                    nextActive = null; 
                }
                if (!nextActive) nextActive = items[items.length - 1];
            }
        } else if (event.key === "Enter") {
            if (activeItem) {
                event.preventDefault(); 
                activeItem.click(); 
                return;
            }
        } else if (event.key === "Escape") {
            removeSuggestBox();
        }

        if (nextActive) {
            if (activeItem) activeItem.classList.remove('active'); 
            nextActive.classList.add('active');
            cityInputEl.value = nextActive.dataset.cityname; 
            nextActive.scrollIntoView({ block: 'nearest' });
        }
    });


    /* ------------------- SEARCH & NAVIGATION ------------------- */

    function performSearch(city) {
        if (city && city.trim() !== "") {
            saveToHistory(city.trim()); // Save to local storage
            window.location.href = `search.html?city=${encodeURIComponent(city.trim())}`;
        } else {
            // UI Feedback for empty search
            cityInputEl.style.border = "2px solid #ff4757"; 
            cityInputEl.placeholder = "Enter city to continue";
            cityInputEl.style.animation = "shake 0.3s";
            setTimeout(() => cityInputEl.style.animation = "", 300);
            
            if (window.navigator && window.navigator.vibrate) {
                window.navigator.vibrate(50);
            }

            cityInputEl.addEventListener('input', function() {
                this.style.border = ""; 
                this.placeholder = "Search here"; 
            }, { once: true });
        }
    }

    document.getElementById("searchBtn").addEventListener("click", function() {
        performSearch(document.getElementById("cityInput").value);
    });

    // Link Handling
    document.querySelectorAll(".links-grid .link-item").forEach(item => {
        item.addEventListener("click", function() {
            const file = this.getAttribute("data-file");
            if (file) window.location.href = file;
        });
    });
    
    document.querySelector('.check-item.category').addEventListener('click', () => window.location.href = 'destinations.html');
    document.querySelector('.check-item.travel').addEventListener('click', () => window.location.href = 'travel-checklist.html');
    document.querySelector('.check-item.faqs').addEventListener('click', () => window.location.href = 'faqs.html');
    document.querySelector('.check-item.settings').addEventListener('click', () => window.location.href = 'mybookings.html');

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
        loadUserName();
        loadCityData(); 
    });

</script>
</body>
</html>