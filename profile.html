<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Your Profile</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
    body {
        background-color: #f7b949;
        font-family: 'Inter', sans-serif;
    }
    .card {
        background: white;
        padding: 2rem;
        border-radius: 1.5rem;
        box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        width: 95%;
        max-width: 430px;
        margin: auto;
        margin-top: 60px;
    }
    .profile-pic {
        width: 110px;
        height: 110px;
        border-radius: 999px;
        object-fit: cover;
        margin: auto;
        border: 3px solid #f7b949;
    }
</style>
</head>

<body>

<div class="card">
    <h2 class="text-center text-3xl font-bold mb-6 text-gray-800">Your Profile</h2>

    <!-- Profile Image -->
    <div class="text-center mb-4">
        <img id="profileImage" class="profile-pic" src="" alt="Profile Picture">

        <!-- Only for email users -->
        <input type="file" id="imageUpload" class="hidden" accept="image/*">
        <button id="changePicBtn"
            class="mt-3 px-4 py-2 bg-gray-200 rounded-lg font-semibold hidden">
            Change Picture
        </button>
    </div>

    <!-- Name -->
    <label class="font-semibold text-gray-700">Full Name</label>
    <input id="nameInput" 
           class="w-full p-3 border rounded-xl my-2" 
           type="text">

    <!-- Email -->
    <label class="font-semibold text-gray-700">Email</label>
    <input id="emailInput" disabled 
           class="w-full p-3 border rounded-xl my-2 bg-gray-100">

    <!-- Save Button -->
    <button id="saveBtn"
        class="w-full mt-4 py-3 rounded-xl font-bold text-white"
        style="background:#f39c12;">
        Save Changes
    </button>

    <!-- Logout -->
    <button id="logoutBtn"
        class="w-full mt-3 py-3 rounded-xl font-bold text-white bg-red-500">
        Logout
    </button>

    <p id="statusMsg" class="text-center mt-4 font-semibold"></p>
</div>


<script type="module">

/* ---------------- Firebase Setup ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { 
    getAuth, 
    onAuthStateChanged,
    signOut
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

import {
    getFirestore,
    doc,
    getDoc,
    setDoc
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";


/* -----------------------------------------
   UPDATED STORAGE BUCKET (IMPORTANT FIX)
------------------------------------------ */
const appId = "travelassistant-1baed";
const firebaseConfig = {
    apiKey: "AIzaSyDtkaHB2ER0RAOpsbW-Eg65wSe7G4Uwrkw",
    authDomain: "travelassistant-1baed.firebaseapp.com",
    projectId: "travelassistant-1baed",
    storageBucket: "travelassistant-1baed.appspot.com",   // ← FIXED HERE
    messagingSenderId: "67570490262",
    appId: "1:67570490262:web:7164a2d838b5517a325bb7"
};


/* Init services */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

/* UI elements */
const profileImage = document.getElementById("profileImage");
const changePicBtn = document.getElementById("changePicBtn");
const imageUpload = document.getElementById("imageUpload");
const nameInput = document.getElementById("nameInput");
const emailInput = document.getElementById("emailInput");
const saveBtn = document.getElementById("saveBtn");
const logoutBtn = document.getElementById("logoutBtn");
const statusMsg = document.getElementById("statusMsg");

let currentUser = null;
let currentPhotoURL = null;


/* ---------------- Load User Data ---------------- */
onAuthStateChanged(auth, async (user) => {
    if (!user) {
        window.location.href = "login.html";
        return;
    }

    currentUser = user;
    emailInput.value = user.email;

    // Firestore path
    const userRef = doc(
        db,
        "artifacts",
        appId,
        "users",
        user.uid,
        "profile",
        "data"
    );

    const snap = await getDoc(userRef);

    if (snap.exists()) {
        const data = snap.data();

        nameInput.value = data.name || "";
        currentPhotoURL =
            data.photoURL ||
            user.photoURL ||
            "https://via.placeholder.com/150";
        profileImage.src = currentPhotoURL;
    } else {
        nameInput.value = user.displayName || "";
        currentPhotoURL =
            user.photoURL ||
            "https://via.placeholder.com/150";
        profileImage.src = currentPhotoURL;
    }

    // If Google user → no picture editing
    if (user.providerData[0].providerId === "google.com") {
        changePicBtn.classList.add("hidden");
    } else {
        changePicBtn.classList.remove("hidden");
    }
});


/* ---------------- Change Picture (Email Users Only) ---------------- */
changePicBtn.addEventListener("click", () => {
    imageUpload.click();
});

imageUpload.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // Upload to Firebase Storage
    const storageRef = ref(storage, `profilePics/${currentUser.uid}.jpg`);
    await uploadBytes(storageRef, file);
    const downloadURL = await getDownloadURL(storageRef);

    currentPhotoURL = downloadURL;
    profileImage.src = downloadURL;

    statusMsg.textContent = "Profile picture updated!";
    statusMsg.style.color = "green";
});


/* ---------------- Save Profile Changes ---------------- */
saveBtn.addEventListener("click", async () => {

    const userRef = doc(
        db,
        "artifacts",
        appId,
        "users",
        currentUser.uid,
        "profile",
        "data"
    );

    await setDoc(
        userRef,
        {
            uid: currentUser.uid,
            email: currentUser.email,
            name: nameInput.value.trim(),
            photoURL: currentPhotoURL,
            updatedAt: new Date().toISOString()
        },
        { merge: true }
    );

    statusMsg.textContent = "Saved successfully!";
    statusMsg.style.color = "green";
});


/* ---------------- Logout ---------------- */
logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "login.html";
});

</script>

</body>
</html>
