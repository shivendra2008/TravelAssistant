<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Your Profile</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
    body {
        background-color: #f7b949;
        font-family: 'Inter', sans-serif;
    }
    .card {
        background: white;
        padding: 2rem;
        border-radius: 1.5rem;
        box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        width: 95%;
        max-width: 430px;
        margin: auto;
        margin-top: 60px;
        position: relative;
    }
    .profile-pic {
        width: 110px;
        height: 110px;
        border-radius: 999px;
        object-fit: cover;
        margin: auto;
        border: 3px solid #f7b949;
    }
    .back-arrow {
        position: absolute;
        top: -50px;
        left: 10px;
        font-size: 28px;
        cursor: pointer;
        color: white;
    }
</style>
</head>

<body>

<div class="card">

    <i class="fas fa-arrow-left back-arrow" onclick="window.location.href='index.html'"></i>

    <h2 class="text-center text-3xl font-bold mb-6 text-gray-800">Your Profile</h2>

    <div class="text-center mb-4">
        <img id="profileImage" class="profile-pic" src="profile-picture.png" alt="Profile Picture">
    </div>

    <label class="font-semibold text-gray-700">Full Name</label>
    <input id="nameInput" disabled class="w-full p-3 border rounded-xl my-2 bg-gray-100" type="text"> 
    
    <label class="font-semibold text-gray-700">Email</label>
    <input id="emailInput" disabled class="w-full p-3 border rounded-xl my-2 bg-gray-100">

    <div class="mt-6">
        <button id="settingsToggle" class="w-full py-3 flex justify-between items-center font-semibold text-gray-700 border rounded-xl px-3">
            Account Settings
            <i class="fas fa-chevron-down" id="settingsIcon"></i>
        </button>

        <div id="settingsPanel" class="hidden mt-3">

            <button id="deleteAccountBtn"
                class="w-full mt-3 py-3 rounded-xl font-bold text-white bg-red-600">
                Delete Account
            </button>

            <!-- CONFIRM DELETE BUTTON (hidden by default) -->
            <button id="confirmDeleteBtn"
                class="w-full mt-3 py-3 rounded-xl font-bold text-white bg-red-700 hidden">
                Confirm Delete
            </button>

        </div>
    </div>

    <button id="logoutBtn"
        class="w-full mt-5 py-3 rounded-xl font-bold text-white bg-gray-700">
        Logout
    </button>

    <p id="statusMsg" class="text-center mt-4 font-semibold"></p>
</div>


<script type="module">

/* ---------- Firebase Setup ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { 
    getAuth, 
    deleteUser
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

import {
    getFirestore,
    doc,
    getDoc,
    deleteDoc,
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const appId = "travelassistant-1baed";
const firebaseConfig = {
    apiKey: "AIzaSyDtkaHB2ER0RAOpsbW-Eg65wSe7G4Uwrkw",
    authDomain: "travelassistant-1baed.firebaseapp.com",
    projectId: "travelassistant-1baed",
    storageBucket: "travelassistant-1baed.appspot.com",
    messagingSenderId: "67570490262",
    appId: "1:67570490262:web:7164a2d838b5517a325bb7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app); 
const db = getFirestore(app);

/* UI Elements */
const deleteAccountBtn = document.getElementById("deleteAccountBtn");
const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
const statusMsg = document.getElementById("statusMsg");
const logoutBtn = document.getElementById("logoutBtn");
const emailInput = document.getElementById("emailInput");
const nameInput = document.getElementById("nameInput");

/* Settings dropdown */
const settingsToggle = document.getElementById("settingsToggle");
const settingsPanel = document.getElementById("settingsPanel");
const settingsIcon = document.getElementById("settingsIcon");

settingsToggle.addEventListener("click", () => {
    const isOpen = !settingsPanel.classList.contains("hidden");
    settingsPanel.classList.toggle("hidden");

    settingsIcon.classList.toggle("fa-chevron-down", isOpen);
    settingsIcon.classList.toggle("fa-chevron-up", !isOpen);
});

/* Load Profile */
const userUid = localStorage.getItem('userUid');
const userEmail = localStorage.getItem('userEmail');

async function loadProfile() {
    if (!userUid || !userEmail) {
        return (window.location.href = "login.html");
    }

    emailInput.value = userEmail;

    const userRef = doc(db, "artifacts", appId, "users", userUid, "profile", "data");
    const snap = await getDoc(userRef);

    const fetchedName = snap.exists() ? snap.data().name : '';
    nameInput.value = fetchedName || userEmail.split("@")[0];
}

loadProfile();

/* DELETE ACCOUNT — Step 1: Show confirm button */
deleteAccountBtn.addEventListener("click", () => {
    statusMsg.innerText = "Click again to permanently delete your account.";
    statusMsg.style.color = "red";

    confirmDeleteBtn.classList.remove("hidden");
});

/* DELETE ACCOUNT — Step 2: Perform deletion */
confirmDeleteBtn.addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user) {
        window.location.href = "login.html";
        return;
    }

    statusMsg.innerText = "Deleting your account...";
    statusMsg.style.color = "orange";

    const userRef = doc(db, "artifacts", appId, "users", user.uid, "profile", "data");

    try {
        await deleteDoc(userRef);
        await deleteUser(user);

        statusMsg.innerText = "Account deleted successfully.";
        statusMsg.style.color = "green";

        setTimeout(() => window.location.href = "login.html", 1500);

    } catch (error) {
        statusMsg.innerText = 
            "Delete failed. Logout → Login → Delete again immediately.";
        statusMsg.style.color = "red";
    }
});

/* LOGOUT */
logoutBtn.addEventListener("click", () => {
    localStorage.removeItem('userUid');
    localStorage.removeItem('userEmail');

    statusMsg.innerText = "Logging out...";
    statusMsg.style.color = "green";

    setTimeout(() => window.location.href = "login.html", 800);
});

</script>

</body>
</html>
