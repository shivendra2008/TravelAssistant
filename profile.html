<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Your Profile</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
    body {
        background-color: #f7b949;
        font-family: 'Inter', sans-serif;
    }
    .card {
        background: white;
        padding: 2rem;
        border-radius: 1.5rem;
        box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        width: 95%;
        max-width: 430px;
        margin: auto;
        margin-top: 60px;
        position: relative;
    }
    .profile-pic {
        width: 110px;
        height: 110px;
        border-radius: 999px;
        object-fit: cover;
        margin: auto;
        border: 3px solid #f7b949;
    }
    .back-arrow {
        position: absolute;
        top: -50px;
        left: 10px;
        font-size: 28px;
        cursor: pointer;
        color: white;
    }
</style>
</head>

<body>

<div class="card">

    <!-- Back -->
    <i class="fas fa-arrow-left back-arrow" onclick="window.location.href='index.html'"></i>

    <h2 class="text-center text-3xl font-bold mb-6 text-gray-800">Your Profile</h2>

    <!-- Profile Photo -->
    <div class="text-center mb-4">
        <img id="profileImage" class="profile-pic" src="" alt="Profile Picture">
    </div>

    <!-- Name -->
    <label class="font-semibold text-gray-700">Full Name</label>
    <input id="nameInput" class="w-full p-3 border rounded-xl my-2" type="text">

    <!-- Email -->
    <label class="font-semibold text-gray-700">Email</label>
    <input id="emailInput" disabled class="w-full p-3 border rounded-xl my-2 bg-gray-100">

    <!-- Save -->
    <button id="saveBtn"
        class="w-full mt-4 py-3 rounded-xl font-bold text-white"
        style="background:#f39c12;">
        Save Changes
    </button>

    <!-- Dropdown Settings -->
    <div class="mt-6">
        <button id="settingsToggle" class="w-full py-3 flex justify-between items-center font-semibold text-gray-700 border rounded-xl px-3">
            Account Settings
            <i class="fas fa-chevron-down" id="settingsIcon"></i>
        </button>

        <div id="settingsPanel" class="hidden mt-3">

            <button id="changePasswordBtn"
                class="w-full mt-2 py-3 rounded-xl font-bold text-white bg-blue-500">
                Change Password
            </button>

            <button id="deleteAccountBtn"
                class="w-full mt-3 py-3 rounded-xl font-bold text-white bg-red-600">
                Delete Account
            </button>

        </div>
    </div>

    <!-- Logout -->
    <button id="logoutBtn"
        class="w-full mt-5 py-3 rounded-xl font-bold text-white bg-gray-700">
        Logout
    </button>

    <p id="statusMsg" class="text-center mt-4 font-semibold"></p>
</div>


<script type="module">

/* ---------- Firebase Setup (unchanged) ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { 
    getAuth, 
    onAuthStateChanged,
    signOut,
    sendPasswordResetEmail,
    deleteUser
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

import {
    getFirestore,
    doc,
    getDoc,
    setDoc
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const appId = "travelassistant-1baed";
const firebaseConfig = {
    apiKey: "AIzaSyDtkaHB2ER0RAOpsbW-Eg65wSe7G4Uwrkw",
    authDomain: "travelassistant-1baed.firebaseapp.com",
    projectId: "travelassistant-1baed",
    storageBucket: "travelassistant-1baed.appspot.com",
    messagingSenderId: "67570490262",
    appId: "1:67570490262:web:7164a2d838b5517a325bb7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* UI elements */
const profileImage = document.getElementById("profileImage");
const nameInput = document.getElementById("nameInput");
const emailInput = document.getElementById("emailInput");
const saveBtn = document.getElementById("saveBtn");
const logoutBtn = document.getElementById("logoutBtn");
const statusMsg = document.getElementById("statusMsg");
const changePasswordBtn = document.getElementById("changePasswordBtn");
const deleteAccountBtn = document.getElementById("deleteAccountBtn");

/* Settings dropdown */
const settingsToggle = document.getElementById("settingsToggle");
const settingsPanel = document.getElementById("settingsPanel");
const settingsIcon = document.getElementById("settingsIcon");

settingsToggle.addEventListener("click", () => {
    const isOpen = !settingsPanel.classList.contains("hidden");
    settingsPanel.classList.toggle("hidden");

    settingsIcon.classList.toggle("fa-chevron-down", isOpen);
    settingsIcon.classList.toggle("fa-chevron-up", !isOpen);
});

/* ---------- Load User + Firestore ---------- */
onAuthStateChanged(auth, async (user) => {
    if (!user) return (window.location.href = "login.html");

    emailInput.value = user.email;

    const userRef = doc(db, "artifacts", appId, "users", user.uid, "profile", "data");
    const snap = await getDoc(userRef);

    nameInput.value = snap.exists() ? snap.data().name : (user.displayName || "");

    // Google photo OR default
    profileImage.src =
        user.providerData[0].providerId === "google.com"
            ? user.photoURL
            : "profile-picture.png";
});

/* ---------- Save ---------- */
saveBtn.addEventListener("click", async () => {
    const user = auth.currentUser;
    const userRef = doc(db, "artifacts", appId, "users", user.uid, "profile", "data");

    await setDoc(userRef, {
        name: nameInput.value.trim(),
        email: user.email,
        updatedAt: new Date().toISOString()
    }, { merge: true });

    statusMsg.textContent = "Saved!";
    statusMsg.style.color = "green";
});

/* Change Password */
changePasswordBtn.addEventListener("click", async () => {
    await sendPasswordResetEmail(auth, auth.currentUser.email);
    alert("Password reset email sent!");
});

/* Delete Account */
deleteAccountBtn.addEventListener("click", async () => {
    if (!confirm("Are you sure? This cannot be undone.")) return;
    await deleteUser(auth.currentUser);
    alert("Account deleted.");
    window.location.href = "login.html";
});

/* Logout */
logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "login.html";
});

</script>

</body>
</html>
