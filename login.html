<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Login â€” Email OTP</title>

<!-- Tailwind + icons (keeps your original look) -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<!-- EmailJS client -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
  body { font-family: 'Inter', sans-serif; background: #f7b949; }
  .card { background:white; padding:2.2rem; border-radius:1.25rem; box-shadow:0 15px 30px rgba(0,0,0,0.12); max-width:420px; margin:64px auto; }
  .otp-box { width:55px; height:60px; border:2px solid #e5e7eb; border-radius:14px; font-size:1.6rem; font-weight:600; text-align:center; transition:.15s; outline:none; }
  .otp-box:focus { border-color:#f7b949; box-shadow:0 0 0 4px rgba(247,185,73,0.25); }
  .hidden { display:none !important; }
  .small-muted { color:#6b7280; font-size:.9rem; }
</style>
</head>

<body>

<!-- LOADING OVERLAY -->
<div id="loadingOverlay" class="fixed inset-0 bg-white/90 flex items-center justify-center text-xl z-50 font-semibold text-[#f7b949]">
  Connecting to service...
</div>

<div class="card">

  <h1 class="text-3xl font-bold text-center mb-4 text-gray-800">Login / Sign Up</h1>

  <!-- STEP 1: Email -->
  <div id="stepEmail">
    <label class="font-semibold text-gray-700">Email</label>
    <input id="emailInput" class="w-full p-3 border rounded-xl my-3" type="email" placeholder="you@example.com" autocomplete="email">

    <div id="nameRow" class="hidden">
      <label class="font-semibold text-gray-700">Full Name</label>
      <input id="nameInput" class="w-full p-3 border rounded-xl my-3" type="text" placeholder="Your full name">
    </div>

    <button id="sendOtpBtn" class="w-full py-3 rounded-xl font-bold text-white mt-2" style="background:#f39c12;">
      Send OTP
    </button>

    <p class="text-center small-muted mt-3">We will email you a 6-digit OTP.</p>
  </div>

  <!-- STEP 2: OTP -->
  <div id="stepOtp" class="hidden">
    <p class="text-center small-muted">Enter the 6-digit code sent to</p>
    <p id="emailShown" class="text-center font-semibold mb-4"></p>

    <div class="flex justify-between mb-4" id="otpContainer">
      <input maxlength="1" class="otp-box" inputmode="numeric" pattern="[0-9]*" />
      <input maxlength="1" class="otp-box" inputmode="numeric" pattern="[0-9]*" />
      <input maxlength="1" class="otp-box" inputmode="numeric" pattern="[0-9]*" />
      <input maxlength="1" class="otp-box" inputmode="numeric" pattern="[0-9]*" />
      <input maxlength="1" class="otp-box" inputmode="numeric" pattern="[0-9]*" />
      <input maxlength="1" class="otp-box" inputmode="numeric" pattern="[0-9]*" />
    </div>

    <button id="verifyOtpBtn" class="w-full py-3 rounded-xl font-bold text-white" style="background:#10b981;">
      Verify OTP
    </button>

    <div class="flex items-center justify-between mt-4">
      <button id="resendBtn" class="text-sm text-blue-600">Resend OTP</button>
      <button id="changeEmailBtn" class="text-sm text-gray-600">Use different email</button>
    </div>

    <p class="text-center small-muted mt-3">Code expires in <span id="countdown">05:00</span></p>
  </div>

  <!-- Status message -->
  <p id="statusMsg" class="text-center mt-4 font-semibold"></p>

</div>

<script type="module">
/* ============================
   FIREBASE IMPORTS
   ============================ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { 
  getAuth,
  signInAnonymously,
  setPersistence,
  browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  collectionGroup,
  query,
  where,
  getDocs
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* ============================
   CONFIG (unchanged)
   ============================ */
const appId = "travelassistant-1baed";
const firebaseConfig = {
  apiKey: "AIzaSyDtkaHB2ER0RAOpsbW-Eg65wSe7G4Uwrkw",
  authDomain: "travelassistant-1baed.firebaseapp.com",
  projectId: "travelassistant-1baed",
  storageBucket: "travelassistant-1baed.appspot.com",
  messagingSenderId: "67570490262",
  appId: "1:67570490262:web:7164a2d838b5517a325bb7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
setPersistence(auth, browserLocalPersistence);

/* ============================
   EmailJS init (use your public key)
   ============================ */
window.emailjs && emailjs.init("ksvsBEaCVrEWDxSG_"); // your public key

/* EmailJS IDs */
const EMAILJS_SERVICE_ID = "service_yx4j3el";
const EMAILJS_TEMPLATE_ID = "template_8djoyfc";

/* ============================
   UI refs
   ============================ */
const loadingOverlay = document.getElementById("loadingOverlay");
const stepEmail = document.getElementById("stepEmail");
const stepOtp = document.getElementById("stepOtp");
const emailInput = document.getElementById("emailInput");
const nameRow = document.getElementById("nameRow");
const nameInput = document.getElementById("nameInput");
const emailShown = document.getElementById("emailShown");
const statusMsg = document.getElementById("statusMsg");
const otpInputs = [...document.querySelectorAll(".otp-box")];
const resendBtn = document.getElementById("resendBtn");
const countdownEl = document.getElementById("countdown");
const sendOtpBtn = document.getElementById("sendOtpBtn");
const verifyOtpBtn = document.getElementById("verifyOtpBtn");

let currentEmail = "";
let isExistingUser = false;
let otpExpiresAt = 0;
let resendCooldown = 30;
let resendTimer = null;
let otpTimer = null;

/* small helpers */
function show(el){ el.classList.remove("hidden"); }
function hide(el){ el.classList.add("hidden"); }

/* initialize UI */
setTimeout(() => {
  try { hide(loadingOverlay); } catch(e){}
  show(stepEmail);
}, 300);

/* ============================
   Firestore helpers
   ============================ */

/* Check if email exists by collectionGroup('data') */
async function emailExists(email) {
  console.log("[DEBUG] emailExists() called for:", email);
  try {
    const cg = collectionGroup(db, "data");
    const q = query(cg, where("email", "==", email));
    console.log("[DEBUG] Prepared query on collectionGroup 'data' for email:", email);
    const snaps = await getDocs(q);
    console.log("[DEBUG] getDocs() completed. snaps.empty =", snaps.empty, "docs:", snaps.docs.length);
    if (snaps.empty) return { exists: false };
    const docSnap = snaps.docs[0];
    const data = docSnap.data();
    return { exists: true, name: data.name || "" };
  } catch (err) {
    console.error("[DEBUG] emailExists() FAILED:", err && err.code, err && err.message, err);
    // show safe fallback and treat as new user (so flow continues)
    statusMsg.textContent = "Unable to check existing user. Proceeding with registration.";
    statusMsg.style.color = "orange";
    return { exists: false, error: true };
  }
}

/* Store OTP in Firestore */
async function storeOtp(email) {
  const otp = String(Math.floor(100000 + Math.random() * 900000));
  const expiresAt = Date.now() + 5 * 60 * 1000;
  await setDoc(doc(db, "otp", email), { code: otp, expiresAt });
  otpExpiresAt = expiresAt;
  return otp;
}

/* Send OTP using EmailJS (template expects {{passcode}}) */
async function sendOtpEmail(userEmail, otp) {
  // emailjs.send(serviceID, templateID, templateParams)
  return emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
    passcode: otp,
    to_email: userEmail // optional, your template uses passcode only but including this is harmless
  });
}

/* ============================
   UI flow handlers
   ============================ */

function startResendCooldown(){
  resendBtn.disabled = true;
  let t = resendCooldown;
  resendBtn.textContent = `Resend OTP (${t}s)`;
  clearInterval(resendTimer);
  resendTimer = setInterval(()=>{
    t--;
    if(t<=0){
      clearInterval(resendTimer);
      resendBtn.disabled = false;
      resendBtn.textContent = "Resend OTP";
    } else {
      resendBtn.textContent = `Resend OTP (${t}s)`;
    }
  },1000);
}

function startOtpCountdown(){
  clearInterval(otpTimer);
  otpTimer = setInterval(()=>{
    let sec = Math.max(0, Math.floor((otpExpiresAt - Date.now())/1000));
    const m = String(Math.floor(sec/60)).padStart(2,"0");
    const s = String(sec%60).padStart(2,"0");
    countdownEl.textContent = `${m}:${s}`;
    if(sec <= 0) clearInterval(otpTimer);
  }, 1000);
}

function goToOtpScreen(){
  hide(stepEmail);
  show(stepOtp);
  emailShown.textContent = currentEmail;
  otpInputs.forEach(i=> i.value="");
  otpInputs[0].focus();
  startOtpCountdown();
}

/* Send OTP button click */
sendOtpBtn.addEventListener("click", async () => {
  statusMsg.textContent = "";
  const email = (emailInput.value || "").trim().toLowerCase();
  if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    statusMsg.textContent = "Enter a valid email";
    statusMsg.style.color = "red";
    return;
  }
  currentEmail = email;
  sendOtpBtn.disabled = true;
  sendOtpBtn.style.opacity = "0.6";

  try {
    const check = await emailExists(email);
    isExistingUser = !!check.exists;

    if (!isExistingUser) {
      // show name input for new user
      show(nameRow);
      if (!nameInput.value.trim()) {
        statusMsg.textContent = "Enter your full name to register";
        statusMsg.style.color = "#374151";
        sendOtpBtn.disabled = false;
        sendOtpBtn.style.opacity = "1";
        return;
      }
    } else {
      hide(nameRow);
      nameInput.value = check.name || "";
    }

    const otp = await storeOtp(email);

    try {
      await sendOtpEmail(email, otp);
      console.log("OTP sent via EmailJS to user email:", email);
      statusMsg.textContent = "OTP sent to your email";
      statusMsg.style.color = "green";
    } catch (sendErr) {
      console.error("EmailJS send error:", sendErr);
      statusMsg.textContent = "Failed to send OTP email. Try again.";
      statusMsg.style.color = "red";
      sendOtpBtn.disabled = false;
      sendOtpBtn.style.opacity = "1";
      return;
    }

    startResendCooldown();
    goToOtpScreen();

  } catch (err) {
    console.error("Send OTP flow error:", err);
    statusMsg.textContent = "Unable to send OTP. Try again later.";
    statusMsg.style.color = "red";
  } finally {
    sendOtpBtn.disabled = false;
    sendOtpBtn.style.opacity = "1";
  }
});

/* Resend OTP */
resendBtn.addEventListener("click", async () => {
  if (!currentEmail) return;
  try {
    const otp = await storeOtp(currentEmail);
    await sendOtpEmail(currentEmail, otp);
    statusMsg.textContent = "OTP resent!";
    statusMsg.style.color = "green";
    startResendCooldown();
  } catch (e) {
    console.error("Resend error:", e);
    statusMsg.textContent = "Unable to resend OTP.";
    statusMsg.style.color = "red";
  }
});

/* Change email */
document.getElementById("changeEmailBtn").addEventListener("click", () => {
  currentEmail = "";
  isExistingUser = false;
  nameInput.value = "";
  hide(stepOtp);
  show(stepEmail);
});

/* OTP inputs UX */
otpInputs.forEach((input, idx) => {
  input.addEventListener("input", (e) => {
    e.target.value = e.target.value.replace(/[^0-9]/g, "");
    if (e.target.value && idx < otpInputs.length - 1) otpInputs[idx+1].focus();
  });
  input.addEventListener("keydown", (e) => {
    if (e.key === "Backspace" && !e.target.value && idx > 0) otpInputs[idx-1].focus();
  });
});

/* Verify OTP */
verifyOtpBtn.addEventListener("click", async () => {
  statusMsg.textContent = "";
  const otp = otpInputs.map(i => i.value.trim()).join("");
  if (otp.length !== 6) {
    statusMsg.textContent = "Enter the 6-digit code";
    statusMsg.style.color = "red";
    return;
  }

  try {
    const snap = await getDoc(doc(db, "otp", currentEmail));
    if (!snap.exists()) {
      statusMsg.textContent = "OTP not found. Request again.";
      statusMsg.style.color = "red";
      return;
    }
    const data = snap.data();
    if (Date.now() > data.expiresAt) {
      statusMsg.textContent = "OTP expired. Resend.";
      statusMsg.style.color = "red";
      return;
    }
    if (data.code !== otp) {
      statusMsg.textContent = "Incorrect OTP";
      statusMsg.style.color = "red";
      return;
    }

    // OTP correct - sign in anonymously and save profile
    const anon = await signInAnonymously(auth);
    const uid = anon.user.uid;

    let finalName = "";
    if (isExistingUser) {
      // try to pull existing name if collection has it
      const check = await emailExists(currentEmail);
      finalName = check.name || currentEmail.split("@")[0];
    } else {
      finalName = nameInput.value.trim() || currentEmail.split("@")[0];
    }

    await setDoc(doc(db, "artifacts", appId, "users", uid, "profile", "data"), {
      uid,
      email: currentEmail,
      name: finalName,
      photoURL: null,
      createdAt: new Date().toISOString()
    }, { merge: true });

    // invalidate OTP
    await setDoc(doc(db, "otp", currentEmail), { code: "", expiresAt: 0 }, { merge: true });

    // redirect to index
    localStorage.setItem("intro_seen", "1");
    window.location.href = "index.html";
    

  } catch (err) {
    console.error("Verify OTP error:", err);
    statusMsg.textContent = "Unable to verify OTP. Try again.";
    statusMsg.style.color = "red";
  }
});
</script>

</body>
</html>
