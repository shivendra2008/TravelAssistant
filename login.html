<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GPay Style â€” Email OTP Mockup</title>

<script src="https://cdn.tailwindcss.com"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
window.addEventListener("load", () => {
    emailjs.init("ksvsBEaCVrEWDxSG_");  // your public key
});
</script>

<style>
  :root {
    --yellow: #f7b81a;
    --top-yellow: #ffb600;
    --muted: #6b7280;
    --thin-border: rgba(0,0,0,0.25);
  }

  body {
    font-family: Inter, system-ui, Arial;
    background: var(--yellow);
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
    margin: 0;
  }
  .btn-loading {
    position: relative;
}

.btn-loading i {
    visibility: hidden; /* Hides arrow icon cleanly */
}

  .wrap {
    width: 100%;
    max-width: 420px;
    border-radius: 28px;
    overflow: hidden;
    background: #fff;
    border: 1px solid #000;
    box-shadow: 0 20px 50px rgba(0,0,0,0.62);
  }

  .top {
    background: var(--top-yellow);
    padding: 48px 30px 70px;
    position: relative;
  }

  .logo {
    width: 64px; height: 64px; border-radius: 12px;
    background: rgba(0,0,0,0.06);
    display:flex; align-items:center; justify-content:center;
  }

  .wave {
    position:absolute; left:0; right:0; bottom:-30px; height:80px;
    background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 120"><path d="M0,60 C150,0 300,120 800,60 L800 120 L0 120 Z" fill="%23ffffff"/></svg>')
      no-repeat center bottom/cover;
  }

  .content {
    padding: 28px 26px 38px;
    margin-top: 10px;
  }

  .pill {
    display:flex; align-items:center; gap:12px;
    padding:12px 16px;
    border-radius:999px;
    background:#fff;
    border:1px solid var(--thin-border);
    box-shadow:0 6px 18px rgba(0,0,0,0.06);
  }

  .pill input {
    background:transparent;
    border:none;
    outline:none;
    width:100%;
    font-weight:600;
    font-size:15px;
  }

  .go {
    width:56px; height:56px;
    border-radius:50%;
    background:#111;
    color:#fff;
    display:flex; align-items:center; justify-content:center;
    margin:14px auto;
    box-shadow:0 12px 28px rgba(0,0,0,0.15);
    border:none;
    cursor:pointer;
    position:relative;
  }

  .go i { color:#fff; font-size:18px; }

  .otp-row {
    display:grid;
    grid-template-columns: repeat(6, 1fr);
    gap:8px;
    margin-top:14px;
    justify-items:center;
  }

  .otp {
    width: 100%; /* Fluid width */
    max-width: 48px; /* Max limit for desktop */
    height:52px;
    box-sizing:border-box;
    font-size:20px;
    text-align:center;
    border-radius:12px;
    background:#f6f6f7;
    border:1px solid var(--thin-border);
    outline:none;
    font-family: ui-monospace, monospace;
    padding: 0; /* Remove padding to prevent sizing issues */
  }

  .otp:focus {
    box-shadow:0 0 0 3px rgba(0,0,0,0.06);
  }

  #verify {
    width:100%; background:#111; color:#fff;
    border-radius:12px; padding:12px; border:none;
    margin-top:12px; display:flex; justify-content:center;
    align-items:center; gap:10px; cursor:pointer;
  }

  #verify i { color:#fff; font-size:14px; }
  #verify.btn-loading {
    position: relative;
}
#verify.btn-loading:after {
    content: "";
    position: absolute;
    width: 18px;
    height: 18px;
    border: 3px solid white;
    border-top-color: transparent;
    border-radius: 50%;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    animation: spin .7s linear infinite;
}
#verify.btn-loading i {
    visibility: hidden;
}

  .muted { color:var(--muted); font-size:13px; }

  .btn-loading { position:relative; pointer-events:none; opacity:0.85; }
  .btn-loading:after {
    content:""; position:absolute; top:50%; left:50%;
    transform:translate(-50%, -50%);
    width:18px; height:18px;
    border:3px solid white;
    border-top-color:transparent;
    border-radius:50%;
    animation:spin .7s linear infinite;
  }

  @keyframes spin { to { transform:translate(-50%, -50%) rotate(360deg);} }

  /* Media Query for Mobile Responsiveness */
  @media (max-width: 400px) {
    .content {
        padding-left: 16px;
        padding-right: 16px;
    }
    .otp-row {
        gap: 4px; /* Reduce gap on small screens */
    }
    .otp {
        height: 45px; /* Slightly shorter */
        font-size: 18px; /* Slightly smaller text */
        border-radius: 8px;
    }
  }
</style>
</head>

<body>

<div class="wrap">

  <div class="top">
    <div style="display:flex; justify-content:space-between;">
      <div>
        <h1 style="font-size:26px;font-weight:700">Welcome!</h1>
        <div style="margin-top:6px;color:rgba(0,0,0,0.75)">Sign in to Continue</div>
      </div>

      <div class="logo">
        <img src="Logo.png" style="width:102px" onerror="this.style.display='none'">
        <!-- Fallback icon if image fails -->
        <i class="fa-solid fa-plane-departure" style="font-size:30px; color:#333; display:none" onload="if(!this.previousElementSibling.complete) this.style.display='block'"></i>
      </div>
    </div>
    <div class="wave"></div>
  </div>

  <div class="content">

    <div id="emailStep">
      <div class="pill" style="margin-bottom:12px">
        <i class="fa-regular fa-envelope text-gray-500"></i>
        <input id="email" placeholder="Email">
      </div>

      <div id="nameRow" style="display:none;margin-bottom:12px">
        <div class="pill">
          <i class="fa-regular fa-user text-gray-500"></i>
          <input id="name" placeholder="Full name">
        </div>
      </div>

      <div style="text-align:center">
        <button id="go" class="go"><i class="fa-solid fa-arrow-right"></i></button>
      </div>
    </div>

    <div id="otpStep" style="display:none">

      <div class="muted small text-center">Enter OTP sent to</div>
      <div id="emailShown" style="text-align:center;font-weight:600;margin-top:6px"></div>

      <div class="otp-row">
        <input maxlength="1" class="otp" inputmode="numeric">
        <input maxlength="1" class="otp" inputmode="numeric">
        <input maxlength="1" class="otp" inputmode="numeric">
        <input maxlength="1" class="otp" inputmode="numeric">
        <input maxlength="1" class="otp" inputmode="numeric">
        <input maxlength="1" class="otp" inputmode="numeric">
      </div>

      <button id="verify">Verify OTP <i class="fa-solid fa-arrow-right"></i></button>

      <div style="display:flex;justify-content:space-between;margin-top:10px">
        <button id="resend" class="muted small">Resend OTP</button>
        <button id="change" class="muted small">Use different email</button>
      </div>

      <div class="muted small" style="text-align:center;margin-top:10px">
        Code expires in <span id="countdown">05:00</span>
      </div>

    </div>

    <div id="status" class="muted small" style="margin-top:12px;text-align:center"></div>

  </div>
</div>

<script type="module">

/* FIREBASE */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth } 
from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collectionGroup, query, where, getDocs } 
from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* CONFIG */
const appId = "travelassistant-1baed";
const firebaseConfig = {
  apiKey: "AIzaSyDtkaHB2ER0RAOpsbW-Eg65wSe7G4Uwrkw",
  authDomain: "travelassistant-1baed.firebaseapp.com",
  projectId: "travelassistant-1baed",
  storageBucket: "travelassistant-1baed.appspot.com",
  messagingSenderId: "67570490262",
  appId: "1:67570490262:web:7164a2d838b5517a325bb7"
};

initializeApp(firebaseConfig);
const auth = getAuth(); 
const db = getFirestore();

/* UI REFS */
const stepEmail = document.getElementById("emailStep");
const stepOtp = document.getElementById("otpStep");
const emailInput = document.getElementById("email");
const nameRow = document.getElementById("nameRow");
const nameInput = document.getElementById("name");
const sendOtpBtn = document.getElementById("go");
const emailShown = document.getElementById("emailShown");
const statusMsg = document.getElementById("status");
const resendBtn = document.getElementById("resend");
const verifyBtn = document.getElementById("verify");
const changeBtn = document.getElementById("change");
const countdownEl = document.getElementById("countdown");
const otpInputs = [...document.querySelectorAll(".otp")];

let currentEmail = "";
let isExistingUser = false;
let otpExpiresAt = 0;
let correctUserName = ""; // Stores the correct name to be persisted

/* UID GENERATOR */
function getUidFromEmail(email) {
    // Creates a unique, stable, and Firestore-doc-ID-safe UID from the email
    return btoa(email).replace(/=+$/, ''); 
}

/* FIRESTORE HELPERS */
async function emailExists(email) {
  // Look inside the "profile" documents under /users
  const q = query(
    collectionGroup(db, "profile"),
    where("email", "==", email)
  );

  const snaps = await getDocs(q);

  if (snaps.empty) {
    return { exists: false, name: "" };
  }

  const data = snaps.docs[0].data();
  return {
    exists: true,
    name: data.name || ""
  };
}


async function storeOtp(email) {
  const otp = String(Math.floor(100000 + Math.random() * 900000));
  const expiresAt = Date.now() + 5 * 60 * 1000;
  otpExpiresAt = expiresAt;
  await setDoc(doc(db, "otp", email), { code: otp, expiresAt });
  return otp;
}


function startOtpCountdown(){
  const timer = setInterval(()=>{
    let sec = Math.max(0, Math.floor((otpExpiresAt - Date.now())/1000));
    countdownEl.textContent = 
      `${String(Math.floor(sec/60)).padStart(2,"0")}:${String(sec%60).padStart(2,"0")}`;
    if(sec<=0) clearInterval(timer);
  },1000);
}

async function sendOtpEmail(userEmail, otp) {
  return emailjs.send("service_yx4j3el", "template_8djoyfc", {
    passcode: otp,
    to_email: userEmail
  });
}

/* TRANSITION */
function goToOtpScreen() {
  stepEmail.style.display = "none";
  stepOtp.style.display = "block";
  emailShown.textContent = currentEmail;
  otpInputs.forEach(i=> i.value="");
  otpInputs[0].focus();
  startOtpCountdown();
}

/* SEND OTP */
sendOtpBtn.addEventListener("click", async ()=>{
  statusMsg.textContent = "";
  const email = emailInput.value.trim().toLowerCase();

  if(!email || !/^\S+@\S+\.\S+$/.test(email)){
    statusMsg.textContent = "Enter a valid email";
    statusMsg.style.color = "red";
    return;
  }

  currentEmail = email;
  sendOtpBtn.classList.add("btn-loading");

  try {
    const check = await emailExists(email);
    isExistingUser = check.exists;
    
    if(isExistingUser){
      nameRow.style.display="none";
      nameInput.value = check.name || ""; // Load name into input (hidden)
      // For existing users, use the name retrieved from the DB (with fallback)
      correctUserName = check.name || email.split("@")[0]; 

    } else {
      nameRow.style.display="block";
      const enteredName = nameInput.value.trim(); // Capture entered name
      if (!enteredName){
        // If new user and no name is entered, prompt to enter name
        statusMsg.textContent = "Please enter your name, then tap GO again.";
        statusMsg.style.color = "red";
        sendOtpBtn.classList.remove("btn-loading");
        return; 
      }
      // For new users, use the name from the input field
      correctUserName = enteredName;
    }

    // --- HARDCODED CREDENTIALS CHECK ---
    if (email === "xyz@travelassist.com") {
        // Hardcoded flow for Verification
        const hardcodedOtp = "123456";
        const expiresAt = Date.now() + 24 * 60 * 60 * 1000; // 24 hours expiry for safety
        otpExpiresAt = expiresAt;
        
        // Write to Firestore so the verify logic works
        await setDoc(doc(db, "otp", email), { code: hardcodedOtp, expiresAt });
        
        // Bypass EmailJS
        console.log("Verification User: Skipping EmailJS. OTP is 123456");

    } else {
        // Standard flow for all other users
        const otp = await storeOtp(email); 
        await sendOtpEmail(email, otp); 
    }
    // --- END HARDCODED CHECK ---

    statusMsg.textContent = "OTP sent!";
    statusMsg.style.color = "green";
    goToOtpScreen();
    
  } catch(err){
    console.error("Full error on send OTP attempt:", err);
    statusMsg.textContent = "Failed to send OTP.";
    statusMsg.style.color="red";
  }

  sendOtpBtn.classList.remove("btn-loading");
});

/* RESEND */
resendBtn.addEventListener("click", async ()=>{
  if(!currentEmail) return;

  try {
    // Standard logic for resend (could also hardcode if strictness needed, but rarely tested on resend)
    const otp = await storeOtp(currentEmail);
    await sendOtpEmail(currentEmail, otp);
    statusMsg.textContent = "OTP resent!";
    statusMsg.style.color="green";
    startOtpCountdown();
  } catch {
    statusMsg.textContent = "Unable to resend";
    statusMsg.style.color="red";
  }
});

/* BACK TO EMAIL */
changeBtn.addEventListener("click", ()=>{
  stepOtp.style.display = "none";
  stepEmail.style.display = "block";
  nameInput.value = ""; 
});

/* OTP INPUT AUTO MOVE */
otpInputs.forEach((input, idx)=>{
  input.addEventListener("input", e=>{
    e.target.value = e.target.value.replace(/\D/g,"");
    if(e.target.value && idx<5) otpInputs[idx+1].focus();
  });
  input.addEventListener("keydown", e=>{
    if(e.key==="Backspace" && !e.target.value && idx>0)
      otpInputs[idx-1].focus();
  });
});

/* VERIFY */
verifyBtn.addEventListener("click", async ()=>{
  const code = otpInputs.map(i=>i.value).join("");

  if(code.length !== 6){
    statusMsg.textContent = "Enter 6 digits";
    statusMsg.style.color="red";
    return;
  }

  try {
    const snap = await getDoc(doc(db,"otp",currentEmail));
    if(!snap.exists()){
      statusMsg.textContent="OTP not found";
      statusMsg.style.color="red";
      return;
    }

    const data = snap.data();
    if(Date.now() > data.expiresAt){
      statusMsg.textContent="OTP expired";
      statusMsg.style.color="red";
      return;
    }

    if(data.code !== code){
      statusMsg.textContent="Incorrect OTP";
      statusMsg.style.color="red";
      return;
    }

    // --- START: NON-ANONYMOUS LOGIN LOGIC (using Stable UID) ---
    const base64Uid = getUidFromEmail(currentEmail);
    
    // Determine the name to set (prioritize input for new, pre-loaded for old)
    let nameToSet;
    if (isExistingUser) {
        // Use the name retrieved from Firestore, with fallback
        nameToSet = correctUserName || currentEmail.split("@")[0];
    } else {
        // Use the name entered by the user, with fallback
        nameToSet = nameInput.value.trim() || currentEmail.split("@")[0];
    }
    
    // 1. Store the session details in Local Storage
    localStorage.setItem('userUid', base64Uid);
    localStorage.setItem('userEmail', currentEmail);
    
    // 2. Store/Update the profile data using the stable UID
    const profileData = {
        uid: base64Uid, 
        email: currentEmail,
        name: nameToSet, // <-- Now robustly set to the username
        photoURL: null,
        createdAt: new Date().toISOString()
    };

    await setDoc(
      doc(db,"artifacts",appId,"users",base64Uid,"profile","data"),
      profileData,
      { merge:true }
    );
    // --- END: NON-ANONYMOUS LOGIN LOGIC ---

    // Clear the OTP
    await setDoc(doc(db,"otp",currentEmail),{ code:"", expiresAt:0 },{ merge:true });

    window.location.href = "index.html";

  } catch (e) {
    console.error(e);
    statusMsg.textContent="Verification failed";
    statusMsg.style.color="red";
  }
});

</script>

</body>
</html>