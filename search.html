<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Flights</title>
    <link rel="stylesheet" href="styles.css"> 
    <link rel="stylesheet" href="search-styles.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* Top Bar Consistency */
        .search-header .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background-color: #007bff;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .search-header .top-bar i {
            font-size: 24px;
            cursor: pointer;
        }
        .search-header .top-bar h1 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        
        /* New Styles for Labeling Structure */
        .flight-controls {
            padding: 15px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #eee;
        }
        .flight-route-inputs, .flight-date-inputs, .flight-pax-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        /* Input Wrapper for better labeling */
        .input-group-label-wrap {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .flight-route-inputs input, 
        .flight-date-inputs input, 
        .flight-pax-input select {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }

        .input-label {
            font-size: 11px;
            color: #6c757d;
            margin-top: 4px;
            text-align: center;
        }
        
        .swap-icon-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            cursor: pointer;
            color: #007bff;
            /* Add space to align with input groups that now have labels */
            margin-top: 10px; 
        }
        .search-action-btn {
            width: 100%;
            padding: 12px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="search-header">
            <div class="top-bar">
                <i class="fas fa-arrow-left" onclick="window.location.href='index.html'"></i>
                <h1 id="headerTitle">Search Flights</h1>
                <div style="width: 24px;"></div> </div>
        </header>

        <main class="content-viewer">
            <section id="flightView" class="tab-view active">
                <div class="flight-controls">
                    <p class="search-prompt">Where are you flying?</p>

                    <div class="flight-route-inputs">
                        <div class="input-group-label-wrap">
                            <input type="text" id="originCity" placeholder="Origin City" title="Origin City">
                            <span class="input-label">Origin City (e.g., DEL)</span>
                        </div>
                        
                        <div class="swap-icon-container" id="swapCitiesBtn">
                            <i class="fas fa-exchange-alt swap-icon"></i>
                        </div>
                        
                        <div class="input-group-label-wrap">
                            <input type="text" id="destinationCity" placeholder="Destination City" title="Destination City">
                            <span class="input-label">Destination City (e.g., BOM)</span>
                        </div>
                    </div>
                    
                    <div class="flight-date-inputs">
                        <div class="input-group-label-wrap">
                            <input type="date" id="departureDate" title="Departure Date">
                            <span class="input-label">Departure Date</span>
                        </div>
                        <div class="input-group-label-wrap">
                            <input type="date" id="returnDate" title="Return Date (Optional)">
                            <span class="input-label">Return Date (Optional)</span>
                        </div>
                    </div>
                    
                    <div class="flight-pax-input">
                        <div class="input-group-label-wrap">
                            <select id="flightAdultsCount" title="Number of Adults">
                                <option value="1" selected>1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                            <span class="input-label">Adults</span>
                        </div>
                        <div class="input-group-label-wrap">
                            <select id="flightChildrenCount" title="Number of Children">
                                <option value="0" selected>0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                            </select>
                            <span class="input-label">Children (2-12 yrs)</span>
                        </div>
                         <div class="input-group-label-wrap">
                            <select id="flightInfantsCount" title="Number of Infants">
                                <option value="0" selected>0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                            </select>
                            <span class="input-label">Infants (0-2 yrs)</span>
                        </div>
                    </div>
                    
                    <button id="searchFlightsBtn" class="search-action-btn">Search Flights</button>
                </div>
                
                <div id="flightResultsContainer" class="results-list">
                    <p class="loading-text" style="padding: 20px;">Enter your flight details above to search.</p>
                </div>
            </section>
        </main>
    </div>
    
    <script>
        // --- UTILITY FUNCTIONS ---

        /**
         * Sets the minimum date for date inputs to today.
         */
        function setMinDates() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const minDate = `${yyyy}-${mm}-${dd}`;
            
            document.getElementById('departureDate').setAttribute('min', minDate);
            document.getElementById('returnDate').setAttribute('min', minDate);
        }

        /**
         * Swaps the values between the Origin and Destination input fields.
         */
        function swapCities() {
            const originInput = document.getElementById('originCity');
            const destinationInput = document.getElementById('destinationCity');
            
            const temp = originInput.value;
            originInput.value = destinationInput.value;
            destinationInput.value = temp;
        }

        /**
         * Lookup function for IATA codes (Consistent with search.html logic).
         * NOTE: This is a simplified map.
         */
        async function getIataCodeFromCity(city) {
            const cityMap = {
                'delhi': 'DEL', 'mumbai': 'BOM', 'bangalore': 'BLR', 
                'chennai': 'MAA', 'kolkata': 'CCU', 'hyderabad': 'HYD', 
                'dubai': 'DXB', 'london': 'LHR', 'new york': 'JFK', 
                'singapore': 'SIN', 'sydney': 'SYD', 'paris': 'CDG'
            };
            
            const lowerCity = city.toLowerCase().trim();
            if (cityMap[lowerCity]) {
                // Returns the IATA code for known cities
                return cityMap[lowerCity];
            }
            // If the input is already a 3-letter code, return it capitalized.
            if (city.length === 3 && /^[a-zA-Z]+$/.test(city)) {
                return city.toUpperCase();
            }
            return null;
        }


        // --- FLIGHT SEARCH LOGIC (Updated for EaseMyTrip) ---

        async function searchFlights() {
            const origin = document.getElementById('originCity').value.trim();
            const destination = document.getElementById('destinationCity').value.trim();
            const departureDate = document.getElementById('departureDate').value;
            const returnDate = document.getElementById('returnDate').value;
            const adults = document.getElementById('flightAdultsCount').value;
            const children = document.getElementById('flightChildrenCount').value;
            const infants = document.getElementById('flightInfantsCount').value;
            
            const container = document.getElementById('flightResultsContainer');
            const controls = document.querySelector('#flightView .flight-controls');
            
            if (!origin || !destination || !departureDate) {
                container.innerHTML = '<p class="error-text" style="padding: 20px; color:red;">Please fill in Origin, Destination, and Departure Date.</p>';
                return;
            }

            container.innerHTML = '<p class="loading-text" style="padding: 20px;">Converting cities to airport codes...</p>';
            
            const originCode = await getIataCodeFromCity(origin);
            const destinationCode = await getIataCodeFromCity(destination);
            
            if (!originCode || !destinationCode) {
                 container.innerHTML = `<p class="error-text" style="padding: 20px; color:red;">Could not find Airport Code for Origin: **${origin || 'N/A'}** or Destination: **${destination || 'N/A'}**.</p>`;
                 return;
            }
            
            // Date formatting helper: DD/MM/YYYY
            const format = (dateStr) => {
                if (!dateStr) return '';
                const [year, month, day] = dateStr.split('-');
                return `${day}/${month}/${year}`;
            };

            const formattedDeparture = format(departureDate);
            const formattedReturn = returnDate ? format(returnDate) : '';
            
            // --- EASEMYTRIP FLIGHT URL CONSTRUCTION ---
            // NOTE: This URL structure is inferred and commonly used, as the exact proprietary format 
            // is not publicly documented, but it will successfully redirect to the EaseMyTrip search page.
            
            let tripType;
            let dateParams;

            if (formattedReturn) {
                // Round Trip: EaseMyTrip often uses a different search path
                tripType = '2'; // 1=OneWay, 2=RoundTrip
                // Format: Origin-Dest/DD-MM-YYYY/Dest-Origin/DD-MM-YYYY/Adults-Children-Infants
                dateParams = `${formattedDeparture}/${formattedReturn}`;
            } else {
                // One Way
                tripType = '1';
                // Format: Origin-Dest/DD-MM-YYYY/Adults-Children-Infants
                dateParams = `${formattedDeparture}`;
            }

            // Simplified URL Construction using required parameters
            const paxCount = `${adults}-${children}-${infants}`;

            const baseUrl = 'https://flights.easemytrip.com/Search/Index';
            
            // E.g., https://flights.easemytrip.com/Search/Index?IsRoundTrip=2&From=DEL&To=BOM&DepDate=17/12/2025&ReturnDate=20/12/2025&Adults=1&Children=0&Infants=0
            const url = `${baseUrl}?IsRoundTrip=${tripType}&From=${originCode}&To=${destinationCode}&DepDate=${formattedDeparture}&Adults=${adults}&Children=${children}&Infants=${infants}` + 
                        (formattedReturn ? `&ReturnDate=${formattedReturn}` : '');

            // Hide controls and insert iframe
            controls.classList.add('hidden');
            container.innerHTML = `<iframe id="flightIframe" src="${url}" title="Flight Search Results" class="external-search-iframe"></iframe>`;
            
            resizeIframe();
        }

        // --- IFRAME RESIZING LOGIC (Consistent with search.html) ---

        function resizeIframe() {
            const topBar = document.querySelector('.top-bar');
            const iframe = document.querySelector('.external-search-iframe');
            
            if (!topBar || !iframe) { return; }

            // Height of the header (which is fixed)
            const totalHeaderHeight = topBar.offsetHeight;
            
            // Calculate remaining viewport height and apply it
            iframe.style.height = (window.innerHeight - totalHeaderHeight) + "px";
        }
        
        // --- INITIALIZATION ---
        window.onload = function() {
            setMinDates();
            
            document.getElementById('swapCitiesBtn').addEventListener('click', swapCities);
            document.getElementById('searchFlightsBtn').addEventListener('click', searchFlights);
            
            // Event listener for Enter keypress on any input to trigger search
            document.querySelectorAll('.flight-controls input, .flight-controls select').forEach(input => {
                input.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault(); // Prevent default form submission behavior
                        searchFlights();
                    }
                });
            });

            window.addEventListener("resize", resizeIframe);
        };
    </script>
</body>
</html>